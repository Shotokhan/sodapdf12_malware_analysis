Facciamo dei filtri semplici relativi ad esempio ad analytics.dll ed ApiPlayaSDK.dll; l'approccio consiste nell'usare evt2sigma, ovvero ci prendiamo gli eventi di interesse da event viewer in formato xml, e da essi generiamo sigma rules usando evt2sigma.

In particolare ci interessano gli eventi del primo processo di Soda, ovvero SodaPdf12Installer.exe, che ha PID 6672, quindi in event viewer si può fare un filtro manuale aggiungendo, nel select path:

*[EventData[Data[@Name="ProcessId"]=6672]]

Inoltre decidiamo di filtrare solo alcuni eventi: DNS query (22), Reg value set (13) e file create (11).

*[EventData[Data[@Name="ProcessId"]=6672] and System[(EventID=22 or EventID=11 or EventID=13)]]

A questo punto restano 14 eventi; salviamo il relativo file .evtx, poi da questo otteniamo gli XML mediante evtx_dump.

Poi usiamo evt2sigma scegliendo quali eventi XML considerare, e modifichiamo opportunamente a mano le regole generate sia per renderle più generiche, sia per assegnargli opportuni titoli e sia per dargli degli ID, altrimenti Zircolite va in errore.

Quindi usiamo sigmac per ottenere il file json:

$ python sigmac --target sqlite -c config/generic/sysmon.yml -c config/generic/powershell.yml -c config/zircolite.yml -d ~/SoftwareSecurity/progetto/ransomware_analysis/rules/sigma/sigma_rules/ -r --output-fields title,id,description,author,tags,level,falsepositives,filename,status --output-format json -o ~/SoftwareSecurity/progetto/ransomware_analysis/rules/sigma/sodapdf12.json --backend-option table=logs

E poi infine Zircolite:

$ python zircolite.py  --evtx ~/SoftwareSecurity/progetto/ransomware_analysis/dynamic/soda_events.evtx --ruleset ~/SoftwareSecurity/progetto/ransomware_analysis/rules/sigma/sodapdf12.json


    ███████╗██╗██████╗  ██████╗ ██████╗ ██╗     ██╗████████╗███████╗
    ╚══███╔╝██║██╔══██╗██╔════╝██╔═══██╗██║     ██║╚══██╔══╝██╔════╝
      ███╔╝ ██║██████╔╝██║     ██║   ██║██║     ██║   ██║   █████╗
     ███╔╝  ██║██╔══██╗██║     ██║   ██║██║     ██║   ██║   ██╔══╝
    ███████╗██║██║  ██║╚██████╗╚██████╔╝███████╗██║   ██║   ███████╗
    ╚══════╝╚═╝╚═╝  ╚═╝ ╚═════╝ ╚═════╝ ╚══════╝╚═╝   ╚═╝   ╚══════╝
   -= Standalone SIGMA Detection tool for EVTX/Auditd/Sysmon Linux =-
    
[+] Checking prerequisites
[+] Extracting EVTX Using 'tmp-4D748PQV' directory 
100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00,  5.58it/s]
[+] Processing EVTX
100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 1/1 [00:00<00:00,  2.46it/s]
[+] Creating model
[+] Inserting data
100%|█████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 3454/3454 [00:00<00:00, 7787.69it/s]
[+] Cleaning unused objects
[+] Loading ruleset from : /home/marcofelix98/SoftwareSecurity/progetto/ransomware_analysis/rules/sigma/sodapdf12.json
[+] Executing ruleset - 6 rules
    - Create SodaPDFDesktop12.exe [medium] : 1 events                                                                                                                   
    - Resolve api.playanext.com [high] : 1 events                                                                                                                       
    - Create PlayaSDK.dll [medium] : 1 events                                                                                                                           
    - Create analytics.dll [low] : 1 events                                                                                                                             
    - Set registry value for Soda uninstall [medium] : 1 events                                                                                                         
    - Resolve download12.sodapdf.com [medium] : 2 events                                                                                                                
100%|████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████████| 6/6 [00:00<00:00, 694.42it/s]
[+] Results written in : detected_events.json
[+] Cleaning

Finished in 1 seconds



